```{r}
library(tidyverse)
library(here)
library(ggrepel)
```

# Study 2: Gender bias and grammar

The findings in Study 1 are consistent with the possibility that people's implicit biases are in part caused by input from language (language-as-causal) and that the linguistic biases simply reflect existing biases (language-as-reflection). In Study 2, we try to distinguish
between these two possibilities by examining whether linguistic biases are associated with grammatical gender, a structural aspect of language that is clearly not caused by people's gender biases. 

Languages can indicate gender in their grammar using a variety of different strategies [@corbett1991]. One way languages grammatically indicate gender is by marking the biological sex of a person in a referential noun phrase (“el ni&ntilde;o alto” (the tall boy) versus “la ni&ntilde;a alta” (the tall girl)). Many languages also extend this strategy beyond biological sex by assinging inantimate objects a "gender" and marking that assigned gender on referring phrases ("el arbol alto" (the tall tree) versus "la casa alta" (the tall house)). 

We hypothesize that grammatical gender might influence cultural stereotypes specifically in cases when it marks biological sex when refering to people. In this cases, grammatical gender highlights the gender of the person and thereby might exaggerate the gender biases present in the language. To the extent that these are causally related to people's implicit biases, languages that mark grammatical mark gender on people may be providing their speakers with additional exposure to gender biases thereby increasing their speakers' implicit biases. In Study 2, we test this hypothesis by asking whether languages that have grammatical marking of gender on people tend to have speakers with larger implicit biases, as measured by the IAT.

### Method

We coded the 26 languages in our sample for two variables: whether or not the grammar made any morphosyntactic gender distinction ("Grammatical General Gender") and whether or not the grammar marked gender on persons specifically ("Grammatical General Gender"). We coded Grammatical General Gender by consulting the WALS typological database [Feature 32a;
@wals] where available and additional resources as necessary. A language was coded as marking General Grammatical Gender if it made a male-female distinction in the grammar. We coded Grammatical Person Gender on the basis of our translations of the 32 IAT words from Study 1b. A language was coded as marking Person Grammatical Gender if it made a gender distinction for any of the target person words. 


```{r}
# occupations scores
INFILE <- here('data/study2/occupation_gender_scores.csv')
by_lang_scores <- read_csv(INFILE)

NATIVE_SPEAKER_LANGS <- c("he", "fr", "es", "de", "da", "ms", "pl", "pt",
                          "hr", "en", "zh", "ko", "nl")

# average across sr and hr
hr_new_occ <- mean(c(filter(by_lang_scores, language_code == "hr") %>%  pull(mean_prop_overlap_occs),
         filter(by_lang_scores, language_code == "sr") %>%  pull(mean_prop_overlap_occs)))
by_lang_scores_tidy <- by_lang_scores %>%
    mutate(mean_prop_overlap_occs = case_when(language_code == "hr" ~ hr_new_occ,
                                  TRUE ~ mean_prop_overlap_occs),
           native_translator = case_when(language_code %in% NATIVE_SPEAKER_LANGS ~ "native",
                                         TRUE ~ "nonnative")) %>%
  filter(language_code != "sr") 
  
BEHAVIORAL_IAT_PATH <- here("data/study0/processed/by_language_df.csv")
iat_behavioral_es <- read_csv(BEHAVIORAL_IAT_PATH) %>%
  rename(language_code = "wiki_language_code") %>%
  select(language_code, median_country_age, 
         prop_male,log_age, es_iat_sex_age_order_explicit_resid,
         es_iat_sex_age_order_implicit_resid, per_women_stem_2012_2017, n_participants)

THEORETICAL_GRAMMAR_PATH <- here("data/study2/general_gender_by_lang.csv")
theoretical_gender <- read_csv(THEORETICAL_GRAMMAR_PATH)  %>%
  select(language_code, wikipedia_grammar_type) %>%
  mutate(wikipedia_grammar_type2 = ifelse(wikipedia_grammar_type %in%  c("none", "CN"),
                                          "No Gender", 
                                          "Gender")) 

LANG_IAT_PATH <- here("data/study1b/iat_es_lang.csv")
iat_lang_es <- read_csv(LANG_IAT_PATH)

LANG_NAME_PATH <- here("data/study0/processed/lang_name_to_wiki_iso.csv")
language_names <- read_csv(LANG_NAME_PATH) %>%
  distinct(wiki_language_code, .keep_all = T)

BY_LANGUAGE_OCCUPATION  <-  here("data/study2/occupation_gender_score_by_language.csv")

occupation_semantics <- read_csv(BY_LANGUAGE_OCCUPATION) 

all_es_tidy2 <- full_join(by_lang_scores_tidy, iat_behavioral_es) %>%
  left_join(theoretical_gender) %>%
  left_join(iat_lang_es)  %>%
  left_join(language_names, by = c("language_code" = "wiki_language_code"))  %>%
  left_join(occupation_semantics)
```



```{r get_corrs2}
# corr of lanng, behavioral, etc.
all_corr_vars <- all_es_tidy2 %>%
  select(lang_es_sub, lang_es_wiki,subt_occu_semantics, wiki_occu_semantics, mean_prop_overlap_occs, es_iat_sex_age_order_explicit_resid, 
         es_iat_sex_age_order_implicit_resid, per_women_stem_2012_2017, median_country_age) %>%
  rename(`Residualized Behavioral IAT` = "es_iat_sex_age_order_implicit_resid",
          `Residualized Explicit Bias` = "es_iat_sex_age_order_explicit_resid",
          `Language IAT (Subtitles)` = "lang_es_sub",
          `Language IAT (Wikipedia)` = "lang_es_wiki",
          `Occupation Bias (Subtitles)` = "subt_occu_semantics",
          `Occupation Bias (Wikipedia)` = "wiki_occu_semantics",
          `Prop. Gender-Neutral Labels` = "mean_prop_overlap_occs",
          `Percent Women in STEM` = "per_women_stem_2012_2017",
          `Median Country Age` = "median_country_age") 

simple_corr <- psych::corr.test(all_corr_vars, adjust = "none")$r %>%
  as_tibble(rownames = "rowname") %>%
  gather("var2", "simple_r", -rowname)
  
simple_corr_p <- psych::corr.test(all_corr_vars, adjust = "none")$p %>%
  as_tibble(rownames = "rowname") %>%
  gather("var2", "simple_p", -rowname)
  
partial_psych_obj <- psych::partial.r(data = all_corr_vars, x = 1:8, y = 9) 
partial_corr <- psych::corr.p(partial_psych_obj, n = nrow(all_corr_vars) - 1, 
                              adjust = "none")$r %>%
  psych_to_mat() %>%
  as_tibble(rownames = "rowname") %>%
  gather("var2", "partial_r", -rowname)

partial_corr_p <- psych::corr.p(partial_psych_obj, n = nrow(all_corr_vars) - 1, 
                                adjust = "none")$p %>%
  psych_to_mat() %>%
  as_tibble(rownames = "rowname") %>%
  gather("var2", "partial_p", -rowname)

tidy_corrs <- simple_corr %>%
                left_join(simple_corr_p) %>%
                left_join(partial_corr) %>%
                left_join(partial_corr_p) 
```

```{r tidy_corrs_for_text2}
text_tidy_corrs <- tidy_corrs %>%
  filter(rowname != var2) %>%
  mutate_at(vars(simple_r, partial_r, simple_p, partial_p), ~ round(.,2)) %>%
  rowwise() %>%
  mutate(r_equality_sign = case_when(simple_p < .01 ~ ", _p_ < .01", 
                                     TRUE ~ paste0(", _p_ = ", simple_p)),
          partial_equality_sign = case_when(partial_p < .01 ~  ", _p_ < .01", 
                                     TRUE ~ paste0(", _p_ = ", partial_p)),
          r_print_text = paste0("_r_ = ", simple_r , r_equality_sign),
          partial_print_text = paste0("_r_ = ", partial_r , partial_equality_sign)) %>%
    mutate_if(is.numeric, ~str_remove(as.character(.), "^0+|^-0+")) 
```


```{r}
print_tidy_corrs <- tidy_corrs %>%
  filter(rowname != var2) %>%
  mutate_at(vars(simple_p, partial_p), ~ case_when(
    . < .01 ~ "**", . < .05 ~ "*",  . < .1 ~ "+", TRUE ~ "")) %>%
  mutate_at(vars(simple_r, partial_r), ~ round(.,2)) %>%
  mutate_if(is.numeric, ~str_remove(as.character(.), "^0+|^-0+")) %>%
  mutate(partial_print = case_when(
    !is.na(partial_r) ~ paste0(" (", partial_r, partial_p, ")"),TRUE ~ ""),
    r_print = paste0(simple_r, simple_p, partial_print)) %>%
  select(rowname, var2, r_print)

tidy_corrs_to_print <- print_tidy_corrs %>%
  spread(var2, r_print)  %>%
  mutate_all(funs(replace_na(., ""))) %>%
  select("rowname", contains("IAT"), 
         contains("Residualized"), 
         contains("STEM"), contains("Age"),contains("Occupation"), contains("Labels")) %>%
  rename(" " = "rowname")

tidy_corrs_to_print_reordered <- tidy_corrs_to_print[c(1,2,8,9,6, 4,5,7, 3),]

kable(tidy_corrs_to_print_reordered, "latex", booktabs = T, escape = F,
      caption = "Correlation (Pearson's r) for all measures in Study 1 and 2 at the level of languages. Numbers in parentheses show partial correlations controlling for median country age. Single astericks indicate p < .05 and double astericks indicate p < .01. The + symbol indicates a marginally significant p-value, p < .1.",
      align = "lrrrrrr") %>%
  column_spec(2:10, width = "1.6cm") %>%
  kable_styling(bootstrap_options = "condensed", 
                full_width = F,  font_size = 7) %>%
  landscape()

```


```{r, fig.pos = "!t!", fig.height = 3.5, fig.width = 4, fig.cap = "Residualized behavioral IAT gender bias as a function of the proportion of gender-netural labels for set of words referring to occupations. Error bands indicate standard error of the model estimate."}
# implicit behavioral ~ prop neutral
ggplot(all_es_tidy2, aes(x = mean_prop_overlap_occs,
                    y = es_iat_sex_age_order_implicit_resid)) +
  geom_smooth(method = "lm", alpha = .1) +
  geom_text_repel(aes(label = language_name), size = 3) +
  geom_point() +
  theme_classic() +
  ggtitle("Behavioral Gender Bias and \nLexicalized Gender") +
  ylab("Behavioral IAT Gender Bias (residualized)") +
  xlab("Proportion Gender-Neutral Occupation Labels") +
  theme(legend.position = "none",
        text = element_text(size = 12),
        axis.text.y = element_text(angle = 90, hjust = 0.5, size = 12))
```


```{r, eval = F, include = F}
  
cor.test(full_df$es_iat_sex_age_order_implicit_resid, 
         full_df$mean_prop_overlap_occs)

m_base1 <- lm(es_iat_sex_age_order_implicit_resid ~ mean_prop_overlap_occs + median_country_age,
   data = full_df)

m_base2 <- lm(es_iat_sex_age_order_implicit_resid ~ wikipedia_grammar_type2 + median_country_age,
   data = full_df)

m_additive <- lm(es_iat_sex_age_order_implicit_resid ~ mean_prop_overlap_occs + wikipedia_grammar_type2 + median_country_age,
   data = full_df) 

m_interaction <- lm(es_iat_sex_age_order_implicit_resid ~ mean_prop_overlap_occs * wikipedia_grammar_type2 + median_country_age,
   data = full_df)

anova(m_additive, m_interaction)


# explicit behavioral
cor.test(full_df$es_iat_sex_age_order_explicit_resid, 
         full_df$mean_prop_overlap_occs)

lm(es_iat_sex_age_order_explicit_resid ~ mean_prop_overlap_occs * wikipedia_grammar_type2 + median_country_age,
   data = full_df) %>%
  summary()

# wiki iat
lm(lang_es_wiki ~ mean_prop_overlap_occs * wikipedia_grammar_type2,
   data = full_df) %>%
  summary()

lm(lang_es_sub ~ mean_prop_overlap_occs * wikipedia_grammar_type2,
   data = full_df) %>%
  summary()

lm(scale(lang_es_sub) ~ scale(mean_prop_overlap_occs) * wikipedia_grammar_type2,
   data = full_df) %>%
  summary()

lm(lang_es_wiki ~ mean_prop_overlap_occs +
     lang_es_wiki
   data = full_df) %>%
  summary()
```

```{r fig.pos = "!t!", fig.height = 3.5, fig.cap = "Residualized behavioral IAT gender bias as a function of mean gender bias of words referring to occupations, with each point corresponding to a language (Study 2). Linguistic biases are estimated from models trained on text in each language from a subtitle corpus (left) and a Wikipedia corpus (right)."}

# plot lang vs behavioral
all_es_tidy2 %>%
  select(language_code, subt_occu_semantics, wiki_occu_semantics,
         es_iat_sex_age_order_implicit_resid) %>%
  gather("model", "occ_lang_es", -language_code,
         -es_iat_sex_age_order_implicit_resid) %>%
  mutate(model = fct_recode(model, "Subtitle Embeddings" = "subt_occu_semantics",
                                   "Wikipedia Embeddings" = "wiki_occu_semantics")) %>%
  ggplot(aes(x = occ_lang_es, y = es_iat_sex_age_order_implicit_resid)) +
  facet_wrap( . ~ model) +
  geom_smooth(method = "lm", alpha = .1, size = .9) +
  ggrepel::geom_text_repel(aes(label = language_code), 
                           size = 3, box.padding = 0.1) + 
  geom_point(size = .7) + 
  theme_minimal() +
  ggtitle("Behavioral and Linguistic Gender Biases") +
  ylab("Behavioral IAT Gender Bias (residualized)\n") +
  xlab("Occupation Gender Bias") +
  theme_classic(base_size = 12) 
```

```{r, eval = F, include = F}

cor.test(full_df$subt_occu_semantics, 
         full_df$wiki_occu_semantics)


lm(scale(es_iat_sex_age_order_implicit_resid) ~ scale(wiki_occu_semantics) + median_country_age,
   data = full_df) %>%
  summary()

cor.test(full_df$es_iat_sex_age_order_implicit_resid, 
         abs(full_df$wiki_occu_semantics))


cor.test(full_df$es_iat_sex_age_order_implicit_resid, 
         full_df$subt_occu_semantics)

# Look at native vs. non-native languages
# filter out low frequency words
# deal with missing hi and japanese translations for occupations
```

