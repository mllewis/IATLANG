---
title: Comparing objective gender measures
author: Molly Lewis 
date: "`r Sys.Date()`"
output: 
  html_document:
    code_folding: hide
    number_sections: no
    toc: yes
---
  
******

```{r setup, include = F}
rm(list = ls())

# load packages
library(knitr)
library(rmarkdown)
library(tidyverse)
library(knitr)
library(broom)
library(corrplot)

opts_chunk$set(echo = T, message = F, warning = F, 
               error = F, tidy = F, cache = F)
```

```{r}
ALPHA <- .05
```

Six gender paritiy indicators:

* GDI: Gender-related Development Index- http://hdr.undp.org/en/data# (Gender Development Index (GDI).csv) 
* GII: Gender Inequality index - http://hdr.undp.org/en/data# (Gender Inequality Index (GII).csv)
* GGI: World Economic Forumâ€™s Gender Gap Index -  http://reports.weforum.org/global-gender-gap-report-2016/rankings/  (WEF_GGGR_Dataset_2016.xlsx)
* SIGI:  https://www.genderindex.org/ranking/  (SIGI.csv)
* WPS: https://giwps.georgetown.edu/the-index/  (WPS_index.csv)
* GPI: Gender Parity Index (MDG) -  Taken from Worldbank (wbstats package)

We exclude GPI because it's missing for about half of countries - shoud look into this.


## IAT bias measures
```{r}
key <- read_csv("../../data/other/country_langiso_langwiki_key.csv") %>%
  select(countryres, wiki_language_code)

# read in and merge bias measures
language_measures <- read_csv("data/other/all_es_wide.csv") %>%
  select(-wps_index, -career_behavioral_iat)

bias_measures <- read_csv("../../data/IAT/Gender-Career/by_country_means_400.csv") %>%
  select(-contains("ci")) %>%
  left_join(key) %>%
  left_join(language_measures)

```

```{r, fig.height = 4}
bias_measures %>%
  gather("measure", "value", c(-1, -5)) %>%
  ggplot(aes(x = measure, y = value)) +
  geom_boxplot() +
  theme_bw()
```

## Objective gender measures
```{r}
#read in gender measures
all_gender_measures <- read_csv("data/gender_measures/all_gender_measures2.csv") %>%
  select(-sigi, -sigi_physical,  -contains("ggi_"), -sigi_son)
```

```{r, fig.width = 7, fig.height = 4}
all_gender_measures %>%
  gather(measure, value, -1:-3) %>%
  ggplot(aes(x = value)) +
  geom_histogram() +
  facet_wrap(~measure, scales = "free", ncol = 4) +
  ggtitle("raw") +
  theme_bw()
```

Transform skewed measures.
```{r, fig.width = 7, fig.height = 4}
all_gender_measures_transformed <- all_gender_measures %>%
  mutate(sigi_fam_log = log(sigi_fam)) %>%
  select(-sigi_fam,) %>%
  mutate(sigi_fam_log = ifelse(is.infinite(sigi_fam_log), NA,  sigi_fam_log))

all_gender_measures_transformed %>%
  gather(measure, value,-1:-2) %>%
  ggplot(aes(x = value)) +
  geom_histogram() +
  ggtitle("transformed")+
  facet_wrap(~measure, scales = "free", ncol = 4) +
  theme_bw()
```

## Correlation between measures - country level
```{r}
# merge together
full_df = bias_measures %>%
  left_join(all_gender_measures_transformed,  by = c("countryres" = "country_code")) %>%
  select(-contains("wiki_language_code"), -country_name, -weapons_google, -career_hand)  
```

```{r small_corr_plot1, fig.height = 6, fig.width = 6}
corr_mat <- cor(full_df[,c(-1)], 
                use = "pairwise.complete.obs")

p.mat <- cor.mtest(full_df[,c(-1)], 
                  conf.level = (1-ALPHA),  
                  use = "pairwise.complete.obs")$p

cols = rev(colorRampPalette(c("red", "white", "blue"))(100))

corrplot(corr_mat, method = "color",  col = cols,
         type = "upper", order = "original", number.cex = .7,
         addCoef.col = "black", 
         p.mat = p.mat, sig.level = ALPHA, insig = "blank", 
         tl.col = "black", tl.srt = 90,
         diag = FALSE)
```

## Correlation between measures - langauge level

```{r}
# merge together
full_df_lang = bias_measures %>%
  left_join(all_gender_measures_transformed,  by = c("countryres" = "country_code")) %>%
  select(-country_name, -weapons_google) %>%
  group_by(wiki_language_code) %>%
  summarize_at(vars(mean:sigi_fam_log), mean) %>%
  select(-wiki_language_code, -career_hand)

corr_mat <- cor(full_df_lang, 
                use = "pairwise.complete.obs")

p.mat <- cor.mtest(full_df_lang, 
                  conf.level = (1-ALPHA),  
                  use = "pairwise.complete.obs")$p

cols = rev(colorRampPalette(c("red", "white", "blue"))(100))

corrplot(corr_mat, method = "color",  col = cols,
         type = "upper", order = "original", number.cex = .7,
         addCoef.col = "black", 
         p.mat = p.mat, sig.level = ALPHA, insig = "blank", 
         tl.col = "black", tl.srt = 90,
         diag = FALSE)
```


```{r}
ggplot(full_df_lang, aes(x = career_google, y = mean)) +
  geom_point() +
  geom_smooth(method = "lm")
```
