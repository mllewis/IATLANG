---
title: IAT LANG - gender-genius
subtitle: 
author: Molly Lewis 
date: "`r Sys.Date()`"
output: 
  html_document:
    code_folding: hide
    number_sections: no
    toc: yes
---
  
******

```{r setup, include = F}
# load packages
library(knitr)
library(rmarkdown)
library(tidyverse)
library(langcog)

opts_chunk$set(echo = T, message = F, warning = F, 
               error = F, tidy = F, cache = F)
```

```{r}
MINPARTICIPANTS <- 8
```


## Language data
```{r}
IAT_lang_full_path <- "genius_effect_sizes_google_full.csv"
IAT_lang_restricted_path <- "genius_effect_sizes_google_restricted.csv"
IAT_lang_restricted_path2 <- "genius_effect_sizes_google_restricted2.csv"
lang_key <- read_tsv("language_name_to_google.csv")
```

I calculated language IAT as in Caliskan et al (2017) for 40 languages in the behavioral data set, using translations from Google Translate. The restricted word list and full word lists effect sizes are highly correlated, so in the following analysis, I ony look at the effect sizes calculated from the restricted set.

```{r, include = F}
## Full
IAT_lang_full_raw <- read_csv(IAT_lang_full_path, 
                          col_names = c("language_code", "test",
                                        "bias_type", "effect_size_full")) 
IAT_lang_full <- IAT_lang_full_raw %>%
  add_row(language_code = "hiur", 
          test = "genius_gender", 
          bias_type = "genius_gender", 
          effect_size_full = mean(filter(IAT_lang_full_raw,
                                         language_code %in% c("hi", "ur")) %>% 
                                    pull(effect_size_full))) %>%
    filter(!(language_code %in% c("hi", "ur")))

## Restricted
IAT_lang_raw1 <- read_csv(IAT_lang_restricted_path,
                                col_names = c("language_code", "test",
                                              "bias_type",
                                              "effect_size_restricted"))


IAT_lang_raw2 <- read_csv(IAT_lang_restricted_path2, 
                          col_names = c("language_code", "test",
                                        "bias_type", "effect_size_restricted")) 

IAT_lang_restricted_raw <- bind_rows(IAT_lang_raw1, IAT_lang_raw2)

IAT_lang_restricted <- IAT_lang_restricted_raw %>%
  add_row(language_code = "hiur", 
          test = "genius_gender", 
          bias_type = "genius_gender", 
          effect_size_restricted = mean(filter(IAT_lang_restricted_raw,
                                         language_code %in% c("hi", "ur")) %>% 
                                    pull(effect_size_restricted))) %>%
  filter(!(language_code %in% c("ur")))

IAT_lang_full %>%
  left_join(IAT_lang_restricted) %>%
  ggplot(aes(x = effect_size_restricted, y = effect_size_full)) +
    geom_label(aes(label = language_code, color = language_code)) +
    geom_smooth(method = "lm") +
    geom_hline(aes(yintercept = 0), linetype = 2) +
    theme_classic() +
    theme(legend.position = "none")
```

## Behavioral data
```{r}
IAT_behavioral_path <-"../../data/IAT/Gender-Genius/InternationalIAT_LanguageData.csv"

IAT_behavioral_path_raw <- read_csv(IAT_behavioral_path)

IAT_behavioral_tidy <- IAT_behavioral_path_raw %>%
  mutate(lang1 = tolower(PrimaryLanguage),
         lang2 = tolower(lang_other_clean),
         Gender = tolower(Gender),
         subid = as.factor(1:n()))  %>%
  rename(iat_score = IATScore2, 
         gender = Gender,
         age = Age,
         country = Country) %>%
  mutate(lang = ifelse(lang1 == "other", lang2, lang1),
         region = as.factor(countrycode::countrycode(country, "country.name", "region"))) %>%
  left_join(lang_key %>% select(language_code, lang)) %>%
  mutate_if(is.character, as.factor) %>%
  select(subid, iat_score, lang, language_code, gender, age, country, region) 
```

There are `r nrow(IAT_behavioral_tidy)` participants in the data, speaking `r length(unique(IAT_behavioral_tidy$language_code))` languages. 
```{r}
lang_counts <- count(IAT_behavioral_tidy, lang)
lang_counts %>%
  arrange(-n) %>%
  DT::datatable()
```

Here are the scores. Are there protocols for exclusions on these?

```{r}
ggplot(IAT_behavioral_tidy, aes(x = iat_score)) +
  geom_histogram() +
  ggtitle("Behavioral IAT score distribtions") +
  theme_classic()
```

```{r, exclusions, include = F}
NSDS <- 4
IAT_behavioral_tidy <-  IAT_behavioral_tidy %>%
 filter(iat_score < mean(IAT_behavioral_tidy$iat_score) + (NSDS*sd(IAT_behavioral_tidy$iat_score)),
         iat_score > mean(IAT_behavioral_tidy$iat_score) - (NSDS*sd(IAT_behavioral_tidy$iat_score))) 
```

## Behavioral IAT vs. Language IAT

### By language

I subset to only those languages that have sufficient speakers. Here the value is set to `r MINPARTICIPANTS`. Here are the mean behavioral IATs by language as a function of language IAT. The ranges are 95% CIs.


```{r}
targ_langs <- lang_counts %>%
  filter(n >= MINPARTICIPANTS) %>%
  pull(lang)

behavioral_means_tidy <- IAT_behavioral_tidy %>%
  filter(lang %in% targ_langs) %>%
  group_by(lang) %>%
  multi_boot_standard(col = "iat_score") %>%
  ungroup()  %>%
  rename(behavioral_mean = mean,
         behavioral_ci_lower = ci_lower,
         behavioral_ci_upper = ci_upper)  %>%
  left_join(lang_key %>% select(language_code, lang))

sample_sizes <- count(IAT_behavioral_tidy, lang) %>%
    left_join(lang_key %>% select(language_code, lang))

full_df <- behavioral_means_tidy %>%
  left_join(IAT_lang_restricted, by = "language_code") %>%
  left_join(sample_sizes, by = "language_code") 
```


```{r}
ggplot(full_df, aes(x = effect_size_restricted, y = behavioral_mean)) +
  geom_pointrange(aes(color = language_code, ymin = behavioral_ci_lower, ymax = behavioral_ci_upper)) +
  geom_text(aes(label = language_code)) +
  xlab("Language IAT effect size") +
  ylab("Behavioral IAT effect size") +
  geom_smooth(method = "lm") +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  theme_classic() +
  theme(legend.position = "none")
```

There's a trend in the predicted direction: languages with higher language IATscores  have higher behavioral IAT.
```{r}
cor.test(full_df$behavioral_mean, 
                full_df$effect_size_restricted)
```

### By participant
This is the same analysis as above, but at the participant level using mixed-effect models.

```{r}
by_participant_df <-  IAT_behavioral_tidy  %>%
  left_join(IAT_lang_restricted, by = "language_code") %>%
  mutate_if(is.numeric, scale)

ggplot(by_participant_df, aes(x = effect_size_restricted, 
                     y = iat_score)) +
  geom_point(aes( color = language_code)) +
  geom_smooth(method = "lm") +
  ylab("Behavioral IAT") +
  xlab("Language IAT") +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  theme_classic() +
  theme(legend.position = "none")
```

In a mixed-effect model with country and language as random intercepts and gender and age as fixed effect, here's no relationship between language IAT and behavioral IAT when you include all languages. All variables are scaled.

```{r}
lme4::lmer(iat_score~effect_size_restricted*gender + age +  (1|country) + (1|lang), by_participant_df) %>%
  summary()
```

But if you exclude languages where we have fewer than `r MINPARTICIPANTS` participants, there's the predicted relationship, when you control for age and gender.
```{r}
targ_langs <- lang_counts %>%
  filter(n >= MINPARTICIPANTS) %>%
  pull(lang)

lme4::lmer(iat_score~effect_size_restricted*gender + age + (1|country)  + (1|lang), 
           by_participant_df %>% filter(lang %in% targ_langs)) %>%
  summary()


lme4::lmer(iat_score~effect_size_restricted*gender + gender*age + (1|country)  + (1|lang), 
           by_participant_df %>% filter(lang %in% targ_langs)) %>%
  summary()
```
